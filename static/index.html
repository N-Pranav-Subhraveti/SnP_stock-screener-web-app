<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .explanation-card ul { list-style-position: inside; }
        .explanation-card li { margin-bottom: 0.5rem; }
        .form-checkbox:checked { background-color: #4f46e5; border-color: #4f46e5; }
        .param-group { display: none; }
        .param-group.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Advanced Stock Screener</h1>
            <p class="text-gray-600 mt-2">Find trade signals with custom parameters and trend validation</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg-col-span-1 space-y-8">
                <!-- Screening Criteria -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Screening Criteria</h2>
                    <form id="screener-form" class="space-y-6">
                        <div>
                            <label for="index" class="block text-sm font-medium text-gray-700">Index</label>
                            <select id="index" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                                <option value="S&P 100">S&P 100</option>
                                <option value="S&P 500">S&P 500</option>
                            </select>
                        </div>
                        <div>
                            <label for="timeframe" class="block text-sm font-medium text-gray-700">Timeframe</label>
                            <select id="timeframe" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div>
                            <label for="strategy" class="block text-sm font-medium text-gray-700">Signal Strategy</label>
                            <select id="strategy" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                                <option value="ma_crossover">MA Crossover</option>
                                <option value="rsi">RSI Oversold</option>
                                <option value="supertrend">Supertrend Signal</option>
                                <option value="ha_pattern">Heikin-Ashi Pattern</option>
                            </select>
                        </div>

                        <!-- Dynamic Strategy Parameters -->
                        <div id="strategy-params-container" class="space-y-4 border-t pt-4">
                            <h3 class="text-md font-medium text-gray-700">Strategy Parameters</h3>
                            <div id="ma_crossover-params" class="param-group space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs">Short Window</label><input type="number" id="ma-short" value="50" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="text-xs">Long Window</label><input type="number" id="ma-long" value="200" class="w-full p-2 border rounded-md"></div>
                                </div>
                            </div>
                            <div id="rsi-params" class="param-group space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                     <div><label class="text-xs">RSI Length</label><input type="number" id="rsi-length" value="14" class="w-full p-2 border rounded-md"></div>
                                     <div><label class="text-xs">Oversold Level</label><input type="number" id="rsi-threshold" value="30" class="w-full p-2 border rounded-md"></div>
                                </div>
                            </div>
                            <div id="supertrend-params" class="param-group space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs">Length</label><input type="number" id="supertrend-length" value="7" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="text-xs">Multiplier</label><input type="number" id="supertrend-multiplier" step="0.1" value="3.0" class="w-full p-2 border rounded-md"></div>
                                </div>
                            </div>
                            <div id="ha_pattern-params" class="param-group">
                                <label class="text-xs">Candle Pattern</label>
                                <input type="text" id="pattern" placeholder="e.g., RRGG" value="RRGG" class="w-full mt-1 p-2 border rounded-md">
                            </div>
                        </div>
                        
                        <div class="flex items-center border-t pt-4">
                            <input id="uptrend-filter" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 form-checkbox">
                            <label for="uptrend-filter" class="ml-2 block text-sm text-gray-900">Apply Adaptive Trend Filter</label>
                        </div>
                        
                        <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition flex items-center justify-center">
                            <span>Run Screener</span>
                        </button>
                    </form>
                </div>

                <!-- Strategy Explanation Card -->
                <div id="explanation-card" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit explanation-card"></div>
                
                <!-- Uptrend Filter Explanation Card (Now Dynamic) -->
                <div id="uptrend-explanation-card" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit explanation-card">
                    <!-- Content will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Results Column -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-semibold">Matching Stocks</h2>
                    <div id="scan-stats" class="text-sm text-gray-600 text-right"></div>
                </div>
                <div id="results-container" class="overflow-x-auto">
                    <div id="loading" class="hidden flex-col items-center justify-center py-12"><div class="loader mb-4"></div><p>Scanning...</p></div>
                    <div id="error-state" class="hidden text-center py-12"><h3>An Error Occurred</h3><p id="error-message" class="text-red-600"></p></div>
                    <div id="empty-state" class="text-center py-12"><h3>No results yet</h3><p>Adjust criteria and run the screener.</p></div>
                    <table id="results-table" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead id="results-thead" class="bg-gray-50"></thead>
                        <tbody id="results-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TradingView Chart Section -->
        <div id="chart-section" class="mt-8 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 hidden">
            <h2 id="chart-ticker-title" class="text-2xl font-semibold mb-4"></h2>
            <div id="tradingview-widget-container" style="height: 500px;"></div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // DOM Elements
        const form = document.getElementById('screener-form');
        const strategySelect = document.getElementById('strategy');
        const explanationCard = document.getElementById('explanation-card');
        const uptrendExplanationCard = document.getElementById('uptrend-explanation-card');
        const resultsTbody = document.getElementById('results-tbody');
        const submitButton = document.getElementById('submit-button');
        const loadingDiv = document.getElementById('loading');
        const errorStateDiv = document.getElementById('error-state');
        const emptyStateDiv = document.getElementById('empty-state');
        const resultsTable = document.getElementById('results-table');
        const scanStatsDiv = document.getElementById('scan-stats');
        const chartSection = document.getElementById('chart-section');

        const explanations = {
            'ma_crossover': { title: "Strategy: MA Crossover", description: "Finds stocks where a shorter-term Simple Moving Average (SMA) has recently crossed above a longer-term SMA. A classic bullish signal." },
            'rsi': { title: "Strategy: RSI Oversold", description: "Finds stocks with a Relative Strength Index (RSI) below a specified threshold, indicating the stock may be oversold and due for a bounce." },
            'supertrend': { title: "Strategy: Supertrend Signal", description: "Finds stocks that have a bullish Supertrend signal, suggesting the stock is in a confirmed uptrend according to this indicator." },
            'ha_pattern': { title: "Strategy: Heikin-Ashi Pattern", description: "Finds stocks matching a specific sequence of 'G' (green) and 'R' (red) Heikin-Ashi candles." }
        };

        const adaptiveFilterExplanations = {
            'ma_crossover': {
                implication: "This is a trend-following signal, so the filter is <strong>strict</strong>. It ensures the crossover is happening within an already established, healthy uptrend.",
                criteria: [
                    "Price > 20-period EMA",
                    "Price > 50-period EMA",
                    "RSI is between 35 and 80",
                    "Volume is > 60% of its 20-period average",
                    "Price is > 85% of its 20-period high"
                ],
                requirement: "At least <strong>3 of 5</strong> conditions must be met."
            },
            'rsi': {
                implication: "This is a momentum/reversal signal, so the filter is more <strong>flexible</strong>. It looks for signs of recovery, even if the trend isn't perfect yet.",
                criteria: [
                    "Price > 20-period EMA (with 2% tolerance)",
                    "Price > 50-period EMA (with 3% tolerance)",
                    "RSI is between 30 and 75",
                    "Volume is > 70% of its 20-period average"
                ],
                requirement: "At least <strong>3 of 4</strong> conditions must be met."
            },
            'supertrend': {
                implication: "This indicator has strong internal trend logic, so the filter is <strong>lenient</strong>. It mainly acts as a sanity check to avoid signals in extremely weak stocks.",
                criteria: [
                    "Price > 50-period EMA (with 5% tolerance)",
                    "RSI is not extremely oversold (> 25)",
                    "Volume is > 50% of its 20-period average"
                ],
                requirement: "At least <strong>2 of 3</strong> conditions must be met."
            },
            'ha_pattern': {
                implication: "This indicator also has internal trend logic, so the filter is <strong>lenient</strong>. It acts as a basic check to ensure the pattern isn't occurring in a free-falling stock.",
                criteria: [
                    "Price > 50-period EMA (with 5% tolerance)",
                    "RSI is not extremely oversold (> 25)",
                    "Volume is > 50% of its 20-period average"
                ],
                requirement: "At least <strong>2 of 3</strong> conditions must be met."
            }
        };

        function updateUI() {
            const strategy = strategySelect.value;
            // Update main strategy explanation
            explanationCard.innerHTML = `<h3 class="text-xl font-semibold mb-2">${explanations[strategy].title}</h3><p class="text-sm text-gray-600">${explanations[strategy].description}</p>`;
            
            // Update adaptive filter explanation
            const filterInfo = adaptiveFilterExplanations[strategy];
            uptrendExplanationCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">About the Adaptive Trend Filter</h3>
                <p class="text-sm text-gray-600">${filterInfo.implication}</p>
                <p class="text-sm text-gray-600 mt-3">For this strategy, the following criteria are checked:</p>
                <ul class="text-sm text-gray-600 list-disc space-y-1 mt-4">
                    ${filterInfo.criteria.map(item => `<li>${item}</li>`).join('')}
                </ul>
                <p class="text-sm font-semibold text-gray-700 mt-4">${filterInfo.requirement}</p>
            `;

            // Show/hide correct parameter inputs
            document.querySelectorAll('.param-group').forEach(el => el.classList.remove('active'));
            document.getElementById(`${strategy}-params`).classList.add('active');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.querySelector('span').textContent = 'Scanning...';
            loadingDiv.classList.remove('hidden');
            loadingDiv.classList.add('flex');
            [resultsTable, emptyStateDiv, errorStateDiv, chartSection].forEach(el => el.classList.add('hidden'));
            scanStatsDiv.innerHTML = '';
            resultsTbody.innerHTML = '';

            const params = getStrategyParams();

            try {
                const response = await fetch('/run-screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        index: document.getElementById('index').value,
                        timeframe: document.getElementById('timeframe').value,
                        strategy: strategySelect.value,
                        params: params,
                        applyUptrendFilter: document.getElementById('uptrend-filter').checked
                    }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'A server error occurred.');
                displayResults(data);
            } catch (error) {
                showErrorState(error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.querySelector('span').textContent = 'Run Screener';
                loadingDiv.classList.add('hidden');
            }
        });

        function getStrategyParams() {
            const strategy = strategySelect.value;
            switch(strategy) {
                case 'ma_crossover':
                    return { short_window: parseInt(document.getElementById('ma-short').value), long_window: parseInt(document.getElementById('ma-long').value) };
                case 'rsi':
                    return { rsi_length: parseInt(document.getElementById('rsi-length').value), rsi_threshold: parseInt(document.getElementById('rsi-threshold').value) };
                case 'supertrend':
                    return { supertrend_length: parseInt(document.getElementById('supertrend-length').value), supertrend_multiplier: parseFloat(document.getElementById('supertrend-multiplier').value) };
                case 'ha_pattern':
                    return { pattern: document.getElementById('pattern').value };
                default:
                    return {};
            }
        }

        function displayResults(data) {
            const { matching_stocks, total_scanned, total_in_index, failed_tickers } = data;
            scanStatsDiv.innerHTML = `Scanned ${total_scanned} of ${total_in_index} stocks. ${failed_tickers.length > 0 ? `<span class="text-red-500">${failed_tickers.length} failed.</span>` : ''}`;

            if (!matching_stocks || matching_stocks.length === 0) {
                emptyStateDiv.classList.remove('hidden');
                emptyStateDiv.querySelector('h3').textContent = "No stocks found";
                emptyStateDiv.querySelector('p').textContent = "Your criteria did not match any stocks.";
                return;
            }
            
            const firstResult = matching_stocks[0];
            const headers = Object.keys(firstResult);
            document.getElementById('results-thead').innerHTML = `<tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}<th class="px-6 py-3"></th></tr>`;
            
            let tableRows = '';
            matching_stocks.forEach(stock => {
                let cells = '';
                headers.forEach(header => {
                    cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock[header] || 'N/A'}</td>`;
                });
                tableRows += `<tr>${cells}<td class="px-6 py-4 text-sm font-medium"><button class="view-chart-btn text-indigo-600 hover:text-indigo-900" data-ticker="${stock.Ticker}">View Chart</button></td></tr>`;
            });
            resultsTbody.innerHTML = tableRows;
            resultsTable.classList.remove('hidden');
        }
        
        function loadTradingViewChart(ticker) {
            document.getElementById('chart-ticker-title').textContent = `TradingView Chart: ${ticker}`;
            const widgetContainer = document.getElementById('tradingview-widget-container');
            widgetContainer.innerHTML = '';
            new TradingView.widget({
                "autosize": true, "symbol": ticker, "interval": "D", "timezone": "Etc/UTC", "theme": "light", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "allow_symbol_change": true, "container_id": "tradingview-widget-container"
            });
            chartSection.classList.remove('hidden');
            chartSection.scrollIntoView();
        }

        function showErrorState(message) {
            document.getElementById('error-message').textContent = message || "An unknown error occurred.";
            errorStateDiv.classList.remove('hidden');
        }

        strategySelect.addEventListener('change', updateUI);
        resultsTbody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('view-chart-btn')) {
                loadTradingViewChart(e.target.dataset.ticker);
            }
        });

        document.addEventListener('DOMContentLoaded', updateUI);
    </script>
</body>
</html>

